SELECT 
    sub.ID,
    sub.obg_no, 
    sub.obl_no,
    sub.ACT_ESCROW_STATUS, 
    sub.ESCROW_AMT_DUE, 
    sub.alt_loan_num,
    sub.proc_tp,
    earliest_date_amount.earliest_date,
    earliest_date_amount.amount
FROM (
    SELECT 
        ROWNUM as ID,
        edr.obg_no, 
        edr.obl_no,
        eai.ACT_ESCROW_STATUS, 
        mep.ESCROW_AMT_DUE, 
        obln.alt_loan_num,
        obln.proc_tp
    FROM 
        esc_disb_rec edr
    LEFT JOIN ESC_ACCT_INDI2 eai ON edr.obg_no = eai.obg_no AND edr.esc_acct_no = eai.ESCROW_ACCT_NO AND edr.obl_no = eai.obl_no
    LEFT JOIN mult_escrow_pntr mep ON mep.ob1_no = edr.obl_no AND mep.ob_no = edr.obg_no AND mep.ESCROW_ACCT_NO = eai.ESCROW_ACCT_NO
    LEFT JOIN obn obln ON mep.obg_no = obln.obg_no AND mep.obl_no = obln.obl_no
) sub
LEFT JOIN (
    SELECT 
        obg_no, 
        obl_no, 
        MIN(date_field) as earliest_date, 
        FIRST_VALUE(amount_field) OVER (PARTITION BY obg_no, obl_no ORDER BY date_field) as amount
    FROM (
        SELECT obg_no, obl_no, dis_dt_1 as date_field, disb_amount_1 as amount_field FROM esc_disb_rec WHERE dis_dt_1 IS NOT NULL
        UNION ALL
        SELECT obg_no, obl_no, dis_dt_2, disb_amount_2 FROM esc_disb_rec WHERE dis_dt_2 IS NOT NULL
        -- Repeat for all date and amount pairs
        UNION ALL
        SELECT obg_no, obl_no, dis_dt_n, disb_amount_n FROM esc_disb_rec WHERE dis_dt_n IS NOT NULL
    )
    GROUP BY obg_no, obl_no
) earliest_date_amount ON sub.obg_no = earliest_date_amount.obg_no AND sub.obl_no = earliest_date_amount.obl_no
WHERE 
    sub.proc_tp >= 5000 
    AND ((sub.disb_type >= 10000 AND sub.disb_type <= 19999) OR sub.disb_type = 40002)
ORDER BY 
    sub.ID;
