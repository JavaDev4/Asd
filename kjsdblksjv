 public JpaItemWriter<U> jpaItemWriter() {
        return new JpaItemWriter<U>() {
            @Override
            public void write(List<? extends U> items) {
                EntityManager entityManager = entityManagerFactory.createEntityManager();
                EntityTransaction transaction = null;

                try {
                    transaction = entityManager.getTransaction();
                    transaction.begin();

                    for (U item : items) {
                        logger.info("Writing item: {}", item); // Log the item here
                        entityManager.persist(item);
                    }

                    transaction.commit();
                } catch (PersistenceException pe) {
                    // Log the exception and the last item attempted to write
                    logger.error("PersistenceException while writing item. Transaction is being rolled back.", pe);
                    if (transaction != null) {
                        transaction.rollback();
                    }
                    // Re-throw the exception to let the framework handle it
                    throw pe;
                } finally {
                    if (entityManager.isOpen()) {
                        entityManager.close();
                    }
                }
            }
        };
    }
